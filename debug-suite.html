<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruleIQ API Debug Suite</title>
    <style>
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #0dbc79;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(13, 188, 121, 0.1);
            border: 1px solid #0dbc79;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #0dbc79;
            font-size: 2.5em;
            margin: 0;
            text-shadow: 0 0 10px rgba(13, 188, 121, 0.5);
        }

        .subtitle {
            color: #64ffda;
            font-size: 1.2em;
            margin-top: 10px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #0dbc79;
            border-radius: 10px;
            background: rgba(13, 188, 121, 0.05);
            backdrop-filter: blur(5px);
        }

        .section-title {
            color: #64ffda;
            font-size: 1.4em;
            margin-bottom: 15px;
            border-bottom: 1px solid #0dbc79;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(45deg, #0dbc79, #64ffda);
            color: #0f0f23;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 180px;
            font-size: 14px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 188, 121, 0.4);
        }

        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
        }

        .trace-log {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #0dbc79;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
        }

        .trace-step {
            margin: 8px 0;
            padding: 12px;
            border-left: 3px solid #0dbc79;
            background: rgba(13, 188, 121, 0.1);
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .error {
            color: #ff6b6b;
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .success {
            color: #0dbc79;
            border-left-color: #0dbc79;
            background: rgba(13, 188, 121, 0.1);
        }

        .pending {
            color: #ffa726;
            border-left-color: #ffa726;
            background: rgba(255, 167, 38, 0.1);
        }

        .info {
            color: #64ffda;
            border-left-color: #64ffda;
            background: rgba(100, 255, 218, 0.1);
        }

        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }

        .endpoint-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .endpoint-card {
            background: rgba(13, 188, 121, 0.1);
            border: 1px solid rgba(13, 188, 121, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .endpoint-card:hover {
            border-color: #0dbc79;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 188, 121, 0.2);
        }

        .endpoint-title {
            color: #64ffda;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .endpoint-method {
            color: #ffa726;
            font-size: 12px;
        }

        .endpoint-desc {
            color: #a0a0a0;
            font-size: 11px;
            margin-top: 5px;
        }

        .status-indicator {
            float: right;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }

        .status-success { background: #0dbc79; }
        .status-error { background: #ff6b6b; }
        .status-pending { background: #ffa726; }

        .config-section {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid #64ffda;
            margin-bottom: 20px;
        }

        input, select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #0dbc79;
            color: #0dbc79;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            margin: 0 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: rgba(13, 188, 121, 0.1);
            border: 1px solid rgba(13, 188, 121, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #64ffda;
        }

        .stat-label {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 5px;
        }

        .api-reference-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(13, 188, 121, 0.3);
        }

        .api-group {
            margin-bottom: 20px;
        }

        .api-item {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(13, 188, 121, 0.05);
            border-left: 3px solid #0dbc79;
            border-radius: 0 4px 4px 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .api-item strong {
            color: #64ffda;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ ruleIQ API Debug Suite</h1>
        <div class="subtitle">Comprehensive API Testing & Monitoring Dashboard</div>
    </div>

    <!-- API Reference Guide -->
    <div class="test-section config-section">
        <div class="section-title">üìö API Reference Guide</div>
        <div style="margin-bottom: 20px;">
            <button onclick="toggleApiReference()" style="background: linear-gradient(45deg, #2196f3, #03a9f4);">üìñ Show/Hide API Guide</button>
        </div>
        <div id="apiReference" style="display: none;">
            <div class="api-reference-content">
                <h3 style="color: #64ffda; margin-bottom: 15px;">üÜì Freemium & Public APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>POST /api/v1/freemium/leads</strong> - Capture lead information from email forms</div>
                    <div class="api-item"><strong>POST /api/v1/freemium/sessions</strong> - Create new assessment sessions for leads</div>
                    <div class="api-item"><strong>GET /api/v1/freemium/sessions/{token}</strong> - Get progress of ongoing assessments</div>
                    <div class="api-item"><strong>POST /api/v1/freemium/sessions/{token}/answers</strong> - Submit assessment answers</div>
                    <div class="api-item"><strong>GET /api/v1/freemium/sessions/{token}/results</strong> - Get assessment results</div>
                    <div class="api-item"><strong>GET /api/v1/freemium/health</strong> - Check freemium service health</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üîê Authentication APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>POST /api/v1/auth/register</strong> - Register new user accounts</div>
                    <div class="api-item"><strong>POST /api/v1/auth/login</strong> - Authenticate users and get tokens</div>
                    <div class="api-item"><strong>POST /api/v1/auth/refresh</strong> - Refresh expired JWT tokens</div>
                    <div class="api-item"><strong>POST /api/v1/auth/logout</strong> - Invalidate user sessions</div>
                    <div class="api-item"><strong>POST /api/v1/auth/forgot-password</strong> - Initiate password reset flow</div>
                    <div class="api-item"><strong>POST /api/v1/auth/reset-password</strong> - Complete password reset</div>
                    <div class="api-item"><strong>GET /api/v1/auth/me</strong> - Get current user profile</div>
                    <div class="api-item"><strong>GET /api/v1/google-auth/*</strong> - Google OAuth integration endpoints</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üë• User Management APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/users</strong> - List users with pagination and filtering</div>
                    <div class="api-item"><strong>POST /api/v1/users</strong> - Create new users (admin only)</div>
                    <div class="api-item"><strong>GET /api/v1/users/{id}</strong> - Get specific user details</div>
                    <div class="api-item"><strong>PUT /api/v1/users/{id}</strong> - Update user information</div>
                    <div class="api-item"><strong>DELETE /api/v1/users/{id}</strong> - Delete user accounts</div>
                    <div class="api-item"><strong>GET /api/v1/users/{id}/activity</strong> - Get user activity logs</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üè¢ Business Profile APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/business-profiles</strong> - List company business profiles</div>
                    <div class="api-item"><strong>POST /api/v1/business-profiles</strong> - Create new business profiles</div>
                    <div class="api-item"><strong>GET /api/v1/business-profiles/{id}</strong> - Get specific business profile</div>
                    <div class="api-item"><strong>PUT /api/v1/business-profiles/{id}</strong> - Update business profile details</div>
                    <div class="api-item"><strong>DELETE /api/v1/business-profiles/{id}</strong> - Delete business profiles</div>
                    <div class="api-item"><strong>POST /api/v1/business-profiles/{id}/validate</strong> - Validate profile completeness</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üìã Assessment APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/assessments</strong> - List all assessments for user/organization</div>
                    <div class="api-item"><strong>POST /api/v1/assessments</strong> - Create new compliance assessments</div>
                    <div class="api-item"><strong>GET /api/v1/assessments/{id}</strong> - Get specific assessment details</div>
                    <div class="api-item"><strong>PUT /api/v1/assessments/{id}</strong> - Update assessment parameters</div>
                    <div class="api-item"><strong>POST /api/v1/assessments/{id}/start</strong> - Begin assessment execution</div>
                    <div class="api-item"><strong>GET /api/v1/assessments/{id}/progress</strong> - Check assessment progress</div>
                    <div class="api-item"><strong>GET /api/v1/assessments/{id}/results</strong> - Get completed assessment results</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">ü§ñ AI-Powered Assessment APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>POST /api/v1/ai-assessments/analyze</strong> - Run AI-powered gap analysis</div>
                    <div class="api-item"><strong>POST /api/v1/ai-assessments/recommendations</strong> - Generate AI compliance recommendations</div>
                    <div class="api-item"><strong>GET /api/v1/ai-assessments/{id}/insights</strong> - Get AI-generated insights</div>
                    <div class="api-item"><strong>POST /api/v1/ai-assessments/batch</strong> - Process multiple assessments via AI</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üõ°Ô∏è Framework Management APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/frameworks</strong> - List available compliance frameworks</div>
                    <div class="api-item"><strong>GET /api/v1/frameworks/{id}</strong> - Get specific framework details</div>
                    <div class="api-item"><strong>GET /api/v1/frameworks/{id}/controls</strong> - Get framework controls and requirements</div>
                    <div class="api-item"><strong>GET /api/v1/frameworks/{id}/mappings</strong> - Get control mappings between frameworks</div>
                    <div class="api-item"><strong>POST /api/v1/frameworks/compare</strong> - Compare multiple frameworks</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üìú Policy Management APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/policies</strong> - List organizational policies</div>
                    <div class="api-item"><strong>POST /api/v1/policies</strong> - Create new policies</div>
                    <div class="api-item"><strong>GET /api/v1/policies/{id}</strong> - Get specific policy content</div>
                    <div class="api-item"><strong>PUT /api/v1/policies/{id}</strong> - Update existing policies</div>
                    <div class="api-item"><strong>POST /api/v1/policies/{id}/approve</strong> - Approve policy for publication</div>
                    <div class="api-item"><strong>GET /api/v1/policies/{id}/history</strong> - Get policy version history</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">ü§ñ AI Policy Generation APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>POST /api/v1/ai/policies/generate</strong> - Generate policies using AI</div>
                    <div class="api-item"><strong>POST /api/v1/ai/policies/review</strong> - AI-powered policy review</div>
                    <div class="api-item"><strong>POST /api/v1/ai/policies/update</strong> - Update policies with AI assistance</div>
                    <div class="api-item"><strong>GET /api/v1/ai/policies/templates</strong> - Get AI-generated policy templates</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üìÅ Evidence Collection APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/evidence</strong> - List collected evidence artifacts</div>
                    <div class="api-item"><strong>POST /api/v1/evidence</strong> - Upload new evidence files</div>
                    <div class="api-item"><strong>GET /api/v1/evidence/{id}</strong> - Get specific evidence item</div>
                    <div class="api-item"><strong>PUT /api/v1/evidence/{id}</strong> - Update evidence metadata</div>
                    <div class="api-item"><strong>POST /api/v1/evidence-collection/scan</strong> - Automated evidence scanning</div>
                    <div class="api-item"><strong>GET /api/v1/foundation-evidence</strong> - Get foundational evidence requirements</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">‚úÖ Compliance Status APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/compliance/status</strong> - Get overall compliance status</div>
                    <div class="api-item"><strong>GET /api/v1/compliance/gaps</strong> - Identify compliance gaps</div>
                    <div class="api-item"><strong>GET /api/v1/compliance/score</strong> - Calculate compliance scores</div>
                    <div class="api-item"><strong>POST /api/v1/compliance/remediate</strong> - Create remediation plans</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üîí Security APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/security/scans</strong> - List security scan results</div>
                    <div class="api-item"><strong>POST /api/v1/security/scan</strong> - Initiate security scans</div>
                    <div class="api-item"><strong>GET /api/v1/security/vulnerabilities</strong> - Get vulnerability reports</div>
                    <div class="api-item"><strong>POST /api/v1/security/remediate</strong> - Create security remediation plans</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üá¨üáß UK Compliance APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/uk-compliance/gdpr</strong> - GDPR compliance assessment</div>
                    <div class="api-item"><strong>GET /api/v1/uk-compliance/data-protection</strong> - UK data protection checks</div>
                    <div class="api-item"><strong>GET /api/v1/uk-compliance/ico</strong> - ICO requirement validation</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üí¨ AI Chat APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>POST /api/v1/chat/message</strong> - Send messages to AI assistant</div>
                    <div class="api-item"><strong>GET /api/v1/chat/history</strong> - Get chat conversation history</div>
                    <div class="api-item"><strong>POST /api/v1/chat/context</strong> - Set conversation context</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üí∞ AI Cost Monitoring APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/ai/cost/usage</strong> - Get AI service usage statistics</div>
                    <div class="api-item"><strong>GET /api/v1/ai/cost/billing</strong> - Get AI cost and billing information</div>
                    <div class="api-item"><strong>WebSocket /api/v1/ai/cost-websocket</strong> - Real-time cost monitoring</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üìä Monitoring & Performance APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/monitoring/health</strong> - System health monitoring</div>
                    <div class="api-item"><strong>GET /api/v1/monitoring/metrics</strong> - System performance metrics</div>
                    <div class="api-item"><strong>GET /api/v1/performance/stats</strong> - Performance statistics</div>
                    <div class="api-item"><strong>GET /api/v1/performance/bottlenecks</strong> - Identify performance bottlenecks</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üìã Reporting APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/reports</strong> - List available reports</div>
                    <div class="api-item"><strong>POST /api/v1/reports/generate</strong> - Generate custom reports</div>
                    <div class="api-item"><strong>GET /api/v1/reports/{id}</strong> - Get specific report</div>
                    <div class="api-item"><strong>GET /api/v1/reports/{id}/download</strong> - Download reports in various formats</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üîå Integration APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/v1/integrations</strong> - List available integrations</div>
                    <div class="api-item"><strong>POST /api/v1/integrations</strong> - Create new integrations</div>
                    <div class="api-item"><strong>PUT /api/v1/integrations/{id}</strong> - Update integration settings</div>
                    <div class="api-item"><strong>POST /api/v1/integrations/{id}/test</strong> - Test integration connectivity</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">‚öôÔ∏è Admin APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /api/admin/users</strong> - Admin user management</div>
                    <div class="api-item"><strong>GET /api/admin/system-status</strong> - System administration status</div>
                    <div class="api-item"><strong>POST /api/admin/maintenance</strong> - Trigger maintenance operations</div>
                    <div class="api-item"><strong>GET /api/admin/logs</strong> - Access system logs</div>
                    <div class="api-item"><strong>GET /api/admin/token-management</strong> - Manage API tokens</div>
                </div>

                <h3 style="color: #64ffda; margin: 20px 0 15px 0;">üíö System Health APIs</h3>
                <div class="api-group">
                    <div class="api-item"><strong>GET /health</strong> - Overall system health check with database status</div>
                    <div class="api-item"><strong>GET /</strong> - Basic API information and version</div>
                    <div class="api-item"><strong>GET /docs</strong> - Interactive API documentation (Swagger)</div>
                    <div class="api-item"><strong>GET /redoc</strong> - Alternative API documentation</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Section -->
    <div class="test-section config-section">
        <div class="section-title">‚öôÔ∏è Configuration</div>
        <div>
            <label>API Base URL:</label>
            <input type="text" id="apiBaseUrl" value="http://localhost:8000" />
            <label>Test Email:</label>
            <input type="text" id="testEmail" value="" />
            <button onclick="updateConfig()">Update Config</button>
            <button onclick="testConnection()" style="background: linear-gradient(45deg, #64ffda, #0dbc79);">Test Connection</button>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="test-section">
        <div class="section-title">üìä Test Statistics</div>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passedTests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedTests">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgResponseTime">0ms</div>
                <div class="stat-label">Avg Response</div>
            </div>
        </div>
    </div>

    <!-- Freemium & Public APIs -->
    <div class="test-section">
        <div class="section-title">üÜì Freemium & Public APIs</div>
        <div class="button-group">
            <button onclick="testFreemiumFlow()">üîÑ Full Freemium Flow</button>
            <button onclick="testEmailCapture()">üìß Email Capture</button>
            <button onclick="testSessionCreation()">üéØ Session Creation</button>
            <button onclick="testAssessmentProgress()">üìà Assessment Progress</button>
        </div>
    </div>

    <!-- Authentication APIs -->
    <div class="test-section">
        <div class="section-title">üîê Authentication APIs</div>
        <div class="button-group">
            <button onclick="testAuthEndpoints()">üîë Auth Flow</button>
            <button onclick="testTokenValidation()">üé´ Token Validation</button>
            <button onclick="testUserRegistration()">üë§ User Registration</button>
            <button onclick="testPasswordReset()">üîÑ Password Reset</button>
            <button onclick="assignTestUserRole()">üë• Assign Test User Role</button>
        </div>
    </div>

    <!-- Core Business APIs -->
    <div class="test-section">
        <div class="section-title">üè¢ Core Business APIs</div>
        <div class="button-group">
            <button onclick="testAssessmentAPIs()">üìã Assessment APIs</button>
            <button onclick="testBusinessProfiles()">üè¢ Business Profiles</button>
            <button onclick="testFrameworkAPIs()">üõ°Ô∏è Frameworks</button>
            <button onclick="testPolicyAPIs()">üìú Policies</button>
        </div>
    </div>

    <!-- AI & Automation APIs -->
    <div class="test-section">
        <div class="section-title">ü§ñ AI & Automation APIs</div>
        <div class="button-group">
            <button onclick="testAIAssessments()">üß† AI Assessments</button>
            <button onclick="testAIPolicyGeneration()">üìù AI Policy Generation</button>
            <button onclick="testChatAPIs()">üí¨ AI Chat</button>
            <button onclick="testAICostMonitoring()">üí∞ AI Cost Monitoring</button>
        </div>
    </div>

    <!-- Compliance & Security APIs -->
    <div class="test-section">
        <div class="section-title">üõ°Ô∏è Compliance & Security APIs</div>
        <div class="button-group">
            <button onclick="testComplianceAPIs()">‚úÖ Compliance Status</button>
            <button onclick="testEvidenceAPIs()">üìÅ Evidence Collection</button>
            <button onclick="testSecurityAPIs()">üîí Security APIs</button>
            <button onclick="testUKComplianceAPIs()">üá¨üáß UK Compliance</button>
        </div>
    </div>

    <!-- Monitoring & Performance APIs -->
    <div class="test-section">
        <div class="section-title">üìà Monitoring & Performance APIs</div>
        <div class="button-group">
            <button onclick="testMonitoringAPIs()">üìä System Monitoring</button>
            <button onclick="testPerformanceAPIs()">‚ö° Performance APIs</button>
            <button onclick="testReportingAPIs()">üìã Reporting APIs</button>
            <button onclick="testIntegrationAPIs()">üîå Integrations</button>
        </div>
    </div>

    <!-- Admin & Management APIs -->
    <div class="test-section">
        <div class="section-title">‚öôÔ∏è Admin & Management APIs</div>
        <div class="button-group">
            <button onclick="testAdminAPIs()">üîß Admin APIs</button>
            <button onclick="testUserManagement()">üë• User Management</button>
            <button onclick="testSystemHealth()">üíö System Health</button>
            <button onclick="testDatabaseAPIs()">üóÑÔ∏è Database APIs</button>
        </div>
    </div>

    <!-- Controls -->
    <div class="test-section">
        <div class="section-title">üéÆ Test Controls</div>
        <div class="button-group">
            <button onclick="runAllTests()" style="background: linear-gradient(45deg, #64ffda, #0dbc79); font-size: 16px; min-width: 200px;">üöÄ RUN ALL TESTS</button>
            <button onclick="runCriticalTests()" style="background: linear-gradient(45deg, #ffa726, #ff9800);">‚ö° Critical Tests Only</button>
            <button onclick="runLoadTest()" style="background: linear-gradient(45deg, #9c27b0, #673ab7);">üî• Load Test</button>
            <button onclick="exportResults()" style="background: linear-gradient(45deg, #2196f3, #03a9f4);">üìä Export Results</button>
            <button onclick="clearLog()" class="clear-btn">üóëÔ∏è Clear Log</button>
        </div>
    </div>

    <!-- Log Output -->
    <div id="trace-log" class="trace-log"></div>

    <script>
        // Configuration
        let config = {
            apiBase: 'http://localhost:8000',
            testEmail: `test-${Date.now()}@example.com`,
            authToken: null,
            sessionToken: null
        };

        // Statistics
        let stats = {
            total: 0,
            passed: 0,
            failed: 0,
            responseTimes: []
        };

        // Utility Functions
        function updateConfig() {
            config.apiBase = document.getElementById('apiBaseUrl').value;
            const emailInput = document.getElementById('testEmail').value;
            if (emailInput) config.testEmail = emailInput;
            else {
                config.testEmail = `test-${Date.now()}@example.com`;
                document.getElementById('testEmail').value = config.testEmail;
            }
            log('‚öôÔ∏è Configuration updated', config, 'info');
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = stats.total;
            document.getElementById('passedTests').textContent = stats.passed;
            document.getElementById('failedTests').textContent = stats.failed;
            
            const avgTime = stats.responseTimes.length > 0 
                ? Math.round(stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length)
                : 0;
            document.getElementById('avgResponseTime').textContent = `${avgTime}ms`;
        }

        // Toggle API reference visibility
        function toggleApiReference() {
            const referenceDiv = document.getElementById('api-reference');
            const button = document.querySelector('button[onclick="toggleApiReference()"]');
            
            if (referenceDiv.style.display === 'none' || referenceDiv.style.display === '') {
                referenceDiv.style.display = 'block';
                button.textContent = 'üìñ Hide API Reference';
            } else {
                referenceDiv.style.display = 'none';
                button.textContent = 'üìñ Show API Reference';
            }
        }

        function log(step, data, status = 'info') {
            const logDiv = document.getElementById('trace-log');
            const entry = document.createElement('div');
            entry.className = `trace-step ${status}`;
            
            const timestamp = new Date().toISOString();
            const dataStr = data ? (typeof data === 'string' ? data : JSON.stringify(data, null, 2)) : '';
            
            entry.innerHTML = `
                <strong>[${timestamp}] ${step}</strong>
                ${dataStr ? `<pre>${dataStr}</pre>` : ''}
            `;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[API DEBUG] ${step}`, data);
        }

        function clearLog() {
            document.getElementById('trace-log').innerHTML = '';
            stats = { total: 0, passed: 0, failed: 0, responseTimes: [] };
            updateStats();
        }

        async function apiCall(endpoint, options = {}) {
            const startTime = Date.now();
            try {
                stats.total++;
                updateStats();

                const url = endpoint.startsWith('http') ? endpoint : `${config.apiBase}${endpoint}`;
                
                // Enhanced logging for debugging
                log('üîß DEBUG: API Call Details', {
                    endpoint: endpoint,
                    fullUrl: url,
                    method: options.method || 'GET',
                    hasAuthToken: !!config.authToken,
                    bodyData: options.body ? JSON.parse(options.body) : null
                }, 'info');
                
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(config.authToken && { 'Authorization': `Bearer ${config.authToken}` })
                    }
                };

                const response = await fetch(url, { ...defaultOptions, ...options });
                const responseTime = Date.now() - startTime;
                stats.responseTimes.push(responseTime);

                // Enhanced response logging
                log('üîß DEBUG: Response Details', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type'),
                    responseTime: `${responseTime}ms`
                }, 'info');

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Network error' }));
                    stats.failed++;
                    updateStats();
                    
                    // Enhanced error logging
                    log('‚ùå API Call Failed', {
                        url: url,
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData
                    }, 'error');
                    
                    throw new Error(`HTTP ${response.status}: ${errorData.detail || response.statusText}`);
                }

                stats.passed++;
                updateStats();
                return await response.json();
            } catch (error) {
                stats.failed++;
                updateStats();
                
                // Enhanced error logging for network/fetch errors
                log('‚ùå API Call Network Error', {
                    endpoint: endpoint,
                    url: endpoint.startsWith('http') ? endpoint : `${config.apiBase}${endpoint}`,
                    errorName: error.name,
                    errorMessage: error.message
                }, 'error');
                
                throw error;
            }
        }

        // üöÄ AUTHENTICATED API CALL WITH AUTO-ROLE ASSIGNMENT
        async function authenticatedApiCall(endpoint, options = {}, requiresAssessmentPerms = false) {
            // Ensure user has required roles before making authenticated calls
            if (config.authToken && requiresAssessmentPerms) {
                await ensureUserHasRequiredRoles();
            }
            
            // Add authorization header if we have a token
            const enhancedOptions = {
                ...options,
                headers: {
                    ...options.headers,
                    ...(config.authToken && { 'Authorization': `Bearer ${config.authToken}` })
                }
            };
            
            return await apiCall(endpoint, enhancedOptions);
        }

        // Test Connection
        async function testConnection() {
            log('üîç Testing API connection...', null, 'pending');
            try {
                const result = await apiCall('/health');
                log('‚úÖ API connection successful', result, 'success');
                return result;
            } catch (error) {
                log('‚ùå API connection failed', { message: error.message }, 'error');
                throw error;
            }
        }

        // Freemium Flow Tests
        async function testEmailCapture() {
            log('üìß Testing email capture...', null, 'pending');
            try {
                const result = await apiCall('/api/v1/freemium/leads', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: config.testEmail,
                        first_name: 'Test',
                        company_name: 'Debug Company'
                    })
                });
                log('‚úÖ Email capture successful', result, 'success');
                return result;
            } catch (error) {
                log('‚ùå Email capture failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testSessionCreation() {
            log('üéØ Testing session creation...', null, 'pending');
            try {
                const result = await apiCall('/api/v1/freemium/sessions', {
                    method: 'POST',
                    body: JSON.stringify({
                        lead_email: config.testEmail,
                        business_type: 'general',
                        assessment_type: 'general'
                    })
                });
                config.sessionToken = result.session_token;
                log('‚úÖ Session creation successful', result, 'success');
                return result;
            } catch (error) {
                log('‚ùå Session creation failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testAssessmentProgress() {
            if (!config.sessionToken) {
                await testSessionCreation();
            }
            log('üìà Testing assessment progress...', null, 'pending');
            try {
                const result = await apiCall(`/api/v1/freemium/sessions/${config.sessionToken}`);
                log('‚úÖ Assessment progress successful', result, 'success');
                return result;
            } catch (error) {
                log('‚ùå Assessment progress failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testFreemiumFlow() {
            log('üîÑ Starting full freemium flow test...', null, 'info');
            try {
                const leadResult = await testEmailCapture();
                const sessionResult = await testSessionCreation();
                const progressResult = await testAssessmentProgress();
                
                log('üéâ Full freemium flow completed successfully!', {
                    leadId: leadResult.lead_id,
                    sessionToken: sessionResult.session_token,
                    progress: progressResult.progress_percentage
                }, 'success');
            } catch (error) {
                log('‚ùå Freemium flow failed', { message: error.message }, 'error');
            }
        }

        // Authentication Tests
        async function testAuthEndpoints() {
            log('üîê Testing authentication flow...', null, 'info');
            try {
                // First test if backend is reachable
                log('üîß Testing backend connectivity...', null, 'pending');
                const healthResult = await apiCall('/health');
                log('‚úÖ Backend is reachable', { 
                    status: healthResult.status, 
                    message: healthResult.message,
                    database: healthResult.database?.engine_initialized 
                }, 'success');
                
                // Test registration endpoint
                await testAuthRegistration();
                
                // Test login with the registered user
                await testAuthLogin();
                
                // Test authenticated endpoint
                await testAuthMe();
                
                log('üéâ Complete auth flow test passed!', null, 'success');
            } catch (error) {
                log('‚ùå Auth flow test failed', { message: error.message }, 'error');
                throw error;
            }
        }

        // üöÄ AUTO-ROLE ASSIGNMENT HELPER
        async function ensureUserHasRequiredRoles() {
            if (!config.authToken) {
                return { success: false, reason: 'No auth token available' };
            }

            try {
                // Check current user permissions
                const userInfo = await apiCall('/api/v1/auth/me', {
                    headers: { 'Authorization': `Bearer ${config.authToken}` }
                });

                // If user already has assessment permissions, no need to assign role
                const hasAssessmentPerms = userInfo.permissions?.some(p => p.includes('assessment')) || false;
                if (hasAssessmentPerms) {
                    return { 
                        success: true, 
                        reason: 'User already has required permissions',
                        permissions: userInfo.permissions?.length || 0
                    };
                }

                // Auto-assign business_user role
                log('üîÑ Auto-assigning required roles...', { trigger: 'permission_check' }, 'pending');
                
                const roleResult = await apiCall('/api/v1/auth/assign-default-role', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                log('‚úÖ Auto-assigned business_user role', {
                    trigger: 'permission_check',
                    total_permissions: roleResult.permissions?.length || 0,
                    assessment_permissions: roleResult.assessment_permissions?.length || 0
                }, 'success');

                return { success: true, reason: 'Role assigned successfully' };

            } catch (error) {
                log('‚ö†Ô∏è Auto role assignment failed', {
                    message: error.message,
                    fallback: 'Manual intervention may be required'
                }, 'warning');
                return { success: false, reason: error.message };
            }
        }

        async function testAuthRegistration() {
            log('üìù Testing user registration...', null, 'pending');
            try {
                // Use a unique email for registration
                const testEmail = `test-${Date.now()}@debugtest.com`;
                const registerData = {
                    email: testEmail,
                    password: 'TestPassword123@'  // Fixed: Use @ instead of ! to avoid JSON escape issues
                };
                
                log('üîß DEBUG: Calling registration endpoint', { 
                    url: `${config.apiBase}/api/v1/auth/register`, 
                    data: registerData 
                }, 'info');
                
                const registerResult = await apiCall('/api/v1/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(registerData)
                });
                
                log('‚úÖ Registration successful', {
                    user_id: registerResult.user.id,
                    email: registerResult.user.email,
                    has_tokens: !!registerResult.tokens
                }, 'success');
                
                // Note about RBAC permissions
                log('‚ÑπÔ∏è Note: Test users need business_user role for API access', {
                    message: 'If API tests fail with 403 permission errors, run: python scripts/assign_test_user_roles.py'
                }, 'info');
                
                // Store credentials for login test
                config.testEmail = testEmail;
                config.currentTestUser = testEmail;  // Store for role assignment
                config.authToken = registerResult.tokens.access_token;
                
                // üöÄ AUTOMATICALLY ASSIGN BUSINESS USER ROLE FOR TESTING
                log('üîÑ Auto-assigning business_user role for seamless testing...', null, 'pending');
                try {
                    const roleResult = await apiCall('/api/v1/auth/assign-default-role', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    log('‚úÖ Auto-assigned business_user role', {
                        user_id: roleResult.user_id,
                        total_permissions: roleResult.permissions?.length || 0,
                        assessment_permissions: roleResult.assessment_permissions?.length || 0,
                        method: 'automatic'
                    }, 'success');
                    
                } catch (roleError) {
                    log('‚ö†Ô∏è Auto role assignment failed - tests may need manual role assignment', {
                        message: roleError.message,
                        fallback: 'Run: python scripts/assign_business_user_role.py'
                    }, 'warning');
                }
                
                return registerResult;
            } catch (error) {
                log('‚ùå Registration failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testAuthLogin() {
            log('üîë Testing login endpoint...', null, 'pending');
            try {
                const loginData = {
                    email: config.testEmail,
                    password: 'TestPassword123@'  // Fixed: Use @ instead of ! to match registration
                };
                
                const loginResult = await apiCall('/api/v1/auth/login', {
                    method: 'POST',
                    body: JSON.stringify(loginData)
                });
                
                config.authToken = loginResult.access_token;
                log('‚úÖ Auth login test passed', {
                    token_type: loginResult.token_type,
                    has_access_token: !!loginResult.access_token,
                    has_refresh_token: !!loginResult.refresh_token
                }, 'success');
                
                return loginResult;
            } catch (error) {
                log('‚ùå Auth login test failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testAuthMe() {
            if (!config.authToken) {
                log('‚ö†Ô∏è No auth token available, skipping /me test', null, 'warning');
                return;
            }
            
            log('üë§ Testing /me endpoint...', null, 'pending');
            try {
                const meResult = await apiCall('/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`
                    }
                });
                
                log('‚úÖ Auth /me test passed', {
                    user_id: meResult.id,
                    email: meResult.email,
                    is_active: meResult.is_active
                }, 'success');
                
                return meResult;
            } catch (error) {
                log('‚ùå Auth /me test failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testTokenValidation() {
            log('üé´ Testing token validation...', null, 'pending');
            try {
                if (!config.authToken) {
                    log('‚ö†Ô∏è No auth token available, testing invalid token handling', null, 'info');
                    
                    // Test with invalid token
                    const invalidResult = await apiCall('/api/v1/auth/me', {
                        headers: {
                            'Authorization': 'Bearer invalid-token-12345'
                        }
                    }).catch(error => error);
                    
                    if (invalidResult instanceof Error) {
                        log('‚úÖ Invalid token correctly rejected', { error: invalidResult.message }, 'success');
                    }
                    return;
                }
                
                // Test with valid token
                const validResult = await apiCall('/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`
                    }
                });
                log('‚úÖ Valid token accepted', { user_id: validResult.id }, 'success');
                
                // Test token refresh if endpoint exists
                try {
                    const refreshResult = await apiCall('/api/v1/auth/refresh', {
                        method: 'POST',
                        body: JSON.stringify({ refresh_token: config.refreshToken })
                    });
                    log('‚úÖ Token refresh successful', { has_new_token: !!refreshResult.access_token }, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è Token refresh not available or failed', { message: error.message }, 'info');
                }
                
            } catch (error) {
                log('‚ùå Token validation failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testUserRegistration() {
            log('üë§ Testing user registration...', null, 'pending');
            try {
                // Test registration with valid data
                const uniqueEmail = `test-reg-${Date.now()}@example.com`;
                const registrationData = {
                    email: uniqueEmail,
                    password: 'SecurePassword123!'
                };
                
                const result = await apiCall('/api/v1/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(registrationData)
                });
                
                log('‚úÖ User registration successful', {
                    user_id: result.user.id,
                    email: result.user.email,
                    has_access_token: !!result.tokens?.access_token
                }, 'success');
                
                // Test duplicate registration (should fail)
                try {
                    await apiCall('/api/v1/auth/register', {
                        method: 'POST',
                        body: JSON.stringify(registrationData)
                    });
                    log('‚ö†Ô∏è Duplicate registration unexpectedly succeeded', null, 'warning');
                } catch (duplicateError) {
                    log('‚úÖ Duplicate registration correctly rejected', { error: duplicateError.message }, 'success');
                }
                
                // Test invalid email format
                try {
                    await apiCall('/api/v1/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({
                            email: 'invalid-email',
                            password: 'ValidPassword123!'
                        })
                    });
                    log('‚ö†Ô∏è Invalid email format unexpectedly accepted', null, 'warning');
                } catch (invalidEmailError) {
                    log('‚úÖ Invalid email format correctly rejected', { error: invalidEmailError.message }, 'success');
                }
                
            } catch (error) {
                log('‚ùå User registration failed', { message: error.message }, 'error');
                throw error;
            }
        }

        async function testPasswordReset() {
            log('üîÑ Testing password reset...', null, 'pending');
            try {
                // Test forgot password request
                const testEmail = config.testEmail || `test-reset-${Date.now()}@example.com`;
                
                log('üìß Testing forgot password request...', null, 'pending');
                try {
                    const forgotResult = await apiCall('/api/v1/auth/forgot-password', {
                        method: 'POST',
                        body: JSON.stringify({
                            email: testEmail
                        })
                    });
                    log('‚úÖ Forgot password request successful', forgotResult, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è Forgot password endpoint not available or failed', { message: error.message }, 'info');
                }
                
                // Test reset password with mock token (this would normally come from email)
                log('üîß Testing password reset with mock token...', null, 'pending');
                try {
                    const resetResult = await apiCall('/api/v1/auth/reset-password', {
                        method: 'POST',
                        body: JSON.stringify({
                            token: 'mock-reset-token-12345',
                            new_password: 'NewSecurePassword123!'
                        })
                    });
                    log('‚úÖ Password reset successful', resetResult, 'success');
                } catch (error) {
                    if (error.message.includes('400') || error.message.includes('invalid') || error.message.includes('token')) {
                        log('‚úÖ Password reset correctly rejected invalid token', { error: error.message }, 'success');
                    } else {
                        log('‚ÑπÔ∏è Password reset endpoint not available or failed', { message: error.message }, 'info');
                    }
                }
                
                // Test with invalid email format for forgot password
                log('üß™ Testing invalid email format...', null, 'pending');
                try {
                    await apiCall('/api/v1/auth/forgot-password', {
                        method: 'POST',
                        body: JSON.stringify({
                            email: 'invalid-email-format'
                        })
                    });
                    log('‚ö†Ô∏è Invalid email format unexpectedly accepted', null, 'warning');
                } catch (error) {
                    log('‚úÖ Invalid email format correctly rejected', { error: error.message }, 'success');
                }
                
                log('‚úÖ Password reset flow tests completed', null, 'success');
                
            } catch (error) {
                log('‚ùå Password reset test failed', { message: error.message }, 'error');
                throw error;
            }
        }

        // Role Assignment Helper
        async function assignTestUserRole() {
            log('üë• Assigning business_user role to test user...', null, 'pending');
            try {
                // Get the latest test user from the auth flow
                if (!config.currentTestUser) {
                    log('‚ö†Ô∏è No current test user found. Please run Auth Flow first.', null, 'warning');
                    return;
                }

                if (!config.authToken) {
                    log('‚ö†Ô∏è No auth token found. Please run Auth Flow first.', null, 'warning');
                    return;
                }

                // First get user ID and role ID 
                log('üîç Looking up user and business_user role IDs...', { email: config.currentTestUser }, 'info');
                
                // Get user ID by calling /me endpoint (since we have the token for the user we want to assign roles to)
                const userInfo = await apiCall('/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`
                    }
                });
                
                const userId = userInfo.id;
                log('‚úÖ Found test user ID', { email: config.currentTestUser, id: userId }, 'success');
                
                // Get business_user role ID by listing available roles
                // Note: This requires admin permissions, so it might fail for regular users
                try {
                    const rolesResult = await apiCall('/api/admin/admin/users/roles/', {
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    
                    const businessUserRole = rolesResult.find(role => role.name === 'business_user');
                    if (!businessUserRole) {
                        throw new Error('business_user role not found');
                    }
                    
                    log('‚úÖ Found business_user role', { roleId: businessUserRole.id }, 'success');
                    
                    // Now assign the role using the correct endpoint
                    const assignmentResult = await apiCall('/api/v1/auth/admin/assign-role', {
                        method: 'POST',
                        body: JSON.stringify({
                            user_id: userId,
                            role_id: businessUserRole.id
                        }),
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    log('‚úÖ Successfully assigned business_user role', {
                        user: config.currentTestUser,
                        assignment_id: assignmentResult.assignment_id,
                        message: assignmentResult.message
                    }, 'success');

                    // Verify the assignment by getting updated user info
                    log('üîç Verifying role assignment...', null, 'pending');
                    const updatedUserInfo = await apiCall('/api/v1/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });

                    const assessmentPerms = updatedUserInfo.permissions?.filter(p => p.includes('assessment')) || [];
                    log('‚úÖ Role assignment completed successfully', {
                        total_permissions: updatedUserInfo.permissions?.length || 0,
                        assessment_permissions: assessmentPerms.length,
                        roles: updatedUserInfo.roles?.map(r => r.name) || [],
                        sample_permissions: updatedUserInfo.permissions?.slice(0, 5) || []
                    }, 'success');

                    return assignmentResult;

                } catch (roleError) {
                    // If we can't access admin endpoints, suggest using the fallback API
                    log('‚ö†Ô∏è User lacks admin permissions for direct role assignment', { 
                        message: roleError.message,
                        user: config.currentTestUser,
                        userId: userId,
                        solution: 'Using fallback role assignment method...'
                    }, 'warning');
                    
                    // Try the fallback method: call a special endpoint that assigns roles
                    log('üîÑ Attempting role assignment via fallback endpoint...', null, 'pending');
                    
                    try {
                        const fallbackResult = await apiCall('/api/v1/auth/assign-default-role', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${config.authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        log('‚úÖ Role assigned via fallback method', fallbackResult, 'success');
                        
                        // Verify the assignment
                        const updatedUserInfo = await apiCall('/api/v1/auth/me', {
                            headers: {
                                'Authorization': `Bearer ${config.authToken}`
                            }
                        });

                        const assessmentPerms = updatedUserInfo.permissions?.filter(p => p.includes('assessment')) || [];
                        log('‚úÖ Fallback role assignment completed', {
                            total_permissions: updatedUserInfo.permissions?.length || 0,
                            assessment_permissions_count: assessmentPerms.length,
                            roles: updatedUserInfo.roles?.map(r => r.name) || []
                        }, 'success');

                        return { success: true, method: 'fallback' };

                    } catch (fallbackError) {
                        log('‚ùå Fallback role assignment also failed', {
                            message: fallbackError.message,
                            user: config.currentTestUser,
                            alternative_instructions: [
                                '1. Open terminal in ruleIQ directory',
                                '2. Run: source .venv/bin/activate',
                                '3. Run: python scripts/assign_business_user_role.py',
                                '4. Return to debug suite and test Assessment APIs'
                            ]
                        }, 'error');
                        
                        return { 
                            success: false, 
                            message: 'Role assignment requires manual script execution',
                            user_id: userId,
                            alternative: 'Run scripts/assign_business_user_role.py manually'
                        };
                    }
                }
                }

            } catch (error) {
                log('‚ùå Role assignment failed', { 
                    message: error.message,
                    user: config.currentTestUser 
                }, 'error');
                
                throw error;
            }
        }

        // Core Business API Tests
        async function testAssessmentAPIs() {
            log('üìã Testing assessment APIs...', null, 'pending');
            try {
                // Ensure we have authentication
                if (!config.authToken) {
                    log('üîë No auth token, running auth flow first...', null, 'info');
                    await testAuthEndpoints();
                }
                
                if (!config.authToken) {
                    log('‚ùå Unable to authenticate for assessment APIs', null, 'error');
                    return;
                }
                
                log('‚úÖ Using authenticated requests for assessment APIs', null, 'info');
                
                // Test GET /api/v1/assessments (list assessments)
                log('üìã Testing list assessments endpoint...', null, 'pending');
                try {
                    const assessmentsList = await authenticatedApiCall('/api/v1/assessments', {}, true);
                    log('‚úÖ List assessments successful', { 
                        count: assessmentsList.length || assessmentsList.total || 'N/A',
                        data: assessmentsList 
                    }, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è List assessments failed or not available', { message: error.message }, 'info');
                }
                
                // Test POST /api/v1/assessments (create assessment)
                log('‚ûï Testing create assessment endpoint...', null, 'pending');
                try {
                    const newAssessment = {
                        session_type: 'compliance_scoping',
                        business_profile_id: null  // Optional - can be null for this test
                    };
                    
                    const createResult = await authenticatedApiCall('/api/v1/assessments', {
                        method: 'POST',
                        body: JSON.stringify(newAssessment)
                    }, true);
                    log('‚úÖ Create assessment successful', { 
                        id: createResult.id,
                        session_type: createResult.session_type,
                        status: createResult.status 
                    }, 'success');
                    
                    // If creation successful, test GET specific assessment
                    if (createResult.id) {
                        log('üîç Testing get specific assessment...', null, 'pending');
                        const specificAssessment = await authenticatedApiCall(`/api/v1/assessments/${createResult.id}`, {}, true);
                        log('‚úÖ Get specific assessment successful', { 
                            id: specificAssessment.id,
                            status: specificAssessment.status 
                        }, 'success');
                    }
                } catch (error) {
                    log('‚ÑπÔ∏è Create assessment failed or not available', { message: error.message }, 'info');
                }
                
                log('üéâ Assessment APIs testing completed', null, 'success');
                
            } catch (error) {
                log('‚ùå Assessment APIs test failed', { message: error.message }, 'error');
            }
        }

        async function testBusinessProfiles() {
            log('üè¢ Testing business profiles...', null, 'pending');
            try {
                // Ensure we have authentication
                if (!config.authToken) {
                    log('üîë No auth token, running auth flow first...', null, 'info');
                    await testAuthEndpoints();
                }
                
                if (!config.authToken) {
                    log('‚ùå Unable to authenticate for business profiles APIs', null, 'error');
                    return;
                }
                
                log('‚úÖ Using authenticated requests for business profiles APIs', null, 'info');
                
                // Test GET /api/v1/business-profiles (list profiles)
                log('üè¢ Testing list business profiles endpoint...', null, 'pending');
                try {
                    const profilesList = await apiCall('/api/v1/business-profiles', {
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ List business profiles successful', { 
                        count: profilesList.length || profilesList.total || 'N/A',
                        data: profilesList 
                    }, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è List business profiles failed or not available', { message: error.message }, 'info');
                }
                
                // Test POST /api/v1/business-profiles (create profile)
                log('‚ûï Testing create business profile endpoint...', null, 'pending');
                try {
                    const newProfile = {
                        name: 'API Test Company',
                        industry: 'Technology',
                        size: '50-100',
                        description: 'Test business profile created via API testing toolkit',
                        website: 'https://api-test.example.com'
                    };
                    
                    const createResult = await apiCall('/api/v1/business-profiles', {
                        method: 'POST',
                        body: JSON.stringify(newProfile),
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ Create business profile successful', { 
                        id: createResult.id,
                        name: createResult.name 
                    }, 'success');
                    
                    // If creation successful, test GET specific profile
                    if (createResult.id) {
                        log('üîç Testing get specific business profile...', null, 'pending');
                        const specificProfile = await apiCall(`/api/v1/business-profiles/${createResult.id}`, {
                            headers: {
                                'Authorization': `Bearer ${config.authToken}`
                            }
                        });
                        log('‚úÖ Get specific business profile successful', { 
                            id: specificProfile.id,
                            name: specificProfile.name 
                        }, 'success');
                    }
                } catch (error) {
                    log('‚ÑπÔ∏è Create business profile failed or not available', { message: error.message }, 'info');
                }
                
                log('üéâ Business profiles APIs testing completed', null, 'success');
                
            } catch (error) {
                log('‚ùå Business profiles test failed', { message: error.message }, 'error');
            }
        }

        async function testFrameworkAPIs() {
            log('üõ°Ô∏è Testing framework APIs...', null, 'pending');
            try {
                // Ensure we have authentication
                if (!config.authToken) {
                    log('üîë No auth token, running auth flow first...', null, 'info');
                    await testAuthEndpoints();
                }
                
                if (!config.authToken) {
                    log('‚ùå Unable to authenticate for framework APIs', null, 'error');
                    return;
                }
                
                log('‚úÖ Using authenticated requests for framework APIs', null, 'info');
                
                const result = await apiCall('/api/v1/frameworks', {
                    headers: {
                        'Authorization': `Bearer ${config.authToken}`
                    }
                });
                log('‚úÖ Framework APIs test passed', result, 'success');
                return result;
            } catch (error) {
                log('‚ùå Framework APIs test failed', { message: error.message }, 'error');
            }
        }

        async function testPolicyAPIs() {
            log('üìú Testing policy APIs...', null, 'pending');
            try {
                // Ensure we have authentication
                if (!config.authToken) {
                    log('üîë No auth token, running auth flow first...', null, 'info');
                    await testAuthEndpoints();
                }
                
                if (!config.authToken) {
                    log('‚ùå Unable to authenticate for policy APIs', null, 'error');
                    return;
                }
                
                log('‚úÖ Using authenticated requests for policy APIs', null, 'info');
                
                // Test GET /api/v1/policies (list policies)
                log('üìú Testing list policies endpoint...', null, 'pending');
                try {
                    const policiesList = await apiCall('/api/v1/policies', {
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ List policies successful', { 
                        count: policiesList.length || policiesList.total || 'N/A',
                        data: policiesList 
                    }, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è List policies failed or not available', { message: error.message }, 'info');
                }
                
                // Test POST /api/v1/policies (create policy)
                log('‚ûï Testing create policy endpoint...', null, 'pending');
                try {
                    const newPolicy = {
                        name: 'API Test Policy',
                        framework: 'ISO27001',
                        description: 'Test policy created via API testing toolkit',
                        content: 'This is a test policy for API validation purposes.'
                    };
                    
                    const createResult = await apiCall('/api/v1/policies', {
                        method: 'POST',
                        body: JSON.stringify(newPolicy),
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ Create policy successful', { 
                        id: createResult.id,
                        name: createResult.name 
                    }, 'success');
                    
                    // If creation successful, test GET specific policy
                    if (createResult.id) {
                        log('üîç Testing get specific policy...', null, 'pending');
                        const specificPolicy = await apiCall(`/api/v1/policies/${createResult.id}`, {
                            headers: {
                                'Authorization': `Bearer ${config.authToken}`
                            }
                        });
                        log('‚úÖ Get specific policy successful', { 
                            id: specificPolicy.id,
                            name: specificPolicy.name 
                        }, 'success');
                    }
                } catch (error) {
                    log('‚ÑπÔ∏è Create policy failed or not available', { message: error.message }, 'info');
                }
                
                log('üéâ Policy APIs testing completed', null, 'success');
                
            } catch (error) {
                log('‚ùå Policy APIs test failed', { message: error.message }, 'error');
            }
        }

        // AI & Automation API Tests
        async function testAIAssessments() {
            log('üß† Testing AI assessments...', null, 'pending');
            try {
                await ensureAuthenticated();
                
                // Test AI assessment endpoint
                log('üß† Testing AI assessment endpoint...', null, 'pending');
                try {
                    const aiAssessmentResult = await apiCall('/api/v1/ai/assessments', {
                        method: 'POST',
                        body: JSON.stringify({
                            framework: 'ISO27001',
                            business_context: 'Small technology company',
                            assessment_type: 'quick'
                        }),
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ AI assessment successful', aiAssessmentResult, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è AI assessment endpoint not available or failed', { message: error.message }, 'info');
                }
                
            } catch (error) {
                log('‚ùå AI assessments authentication failed', { message: error.message }, 'error');
            }
        }

        async function testAIPolicyGeneration() {
            log('üìù Testing AI policy generation...', null, 'pending');
            try {
                await ensureAuthenticated();
                
                // Test AI policy generation endpoint
                log('üìù Testing AI policy generation endpoint...', null, 'pending');
                try {
                    const aiPolicyResult = await apiCall('/api/v1/ai/policies/generate', {
                        method: 'POST',
                        body: JSON.stringify({
                            framework: 'ISO27001',
                            policy_type: 'data_protection',
                            business_context: 'Small technology company handling customer data'
                        }),
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ AI policy generation successful', aiPolicyResult, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è AI policy generation endpoint not available or failed', { message: error.message }, 'info');
                }
                
            } catch (error) {
                log('‚ùå AI policy generation authentication failed', { message: error.message }, 'error');
            }
        }

        async function testChatAPIs() {
            log('üí¨ Testing AI chat APIs...', null, 'pending');
            try {
                await ensureAuthenticated();
                
                // Test AI chat endpoint
                log('üí¨ Testing AI chat endpoint...', null, 'pending');
                try {
                    const chatResult = await apiCall('/api/v1/ai/chat', {
                        method: 'POST',
                        body: JSON.stringify({
                            message: 'What are the key components of ISO 27001?',
                            context: 'compliance_guidance'
                        }),
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ AI chat successful', chatResult, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è AI chat endpoint not available or failed', { message: error.message }, 'info');
                }
                
            } catch (error) {
                log('‚ùå AI chat authentication failed', { message: error.message }, 'error');
            }
        }

        async function testAICostMonitoring() {
            log('üí∞ Testing AI cost monitoring...', null, 'pending');
            try {
                await ensureAuthenticated();
                
                // Test AI cost monitoring endpoint
                log('üí∞ Testing AI cost monitoring endpoint...', null, 'pending');
                try {
                    const costResult = await apiCall('/api/v1/ai/costs', {
                        headers: {
                            'Authorization': `Bearer ${config.authToken}`
                        }
                    });
                    log('‚úÖ AI cost monitoring successful', costResult, 'success');
                } catch (error) {
                    log('‚ÑπÔ∏è AI cost monitoring endpoint not available or failed', { message: error.message }, 'info');
                }
                
            } catch (error) {
                log('‚ùå AI cost monitoring authentication failed', { message: error.message }, 'error');
            }
        }

        // System API Tests
        async function testSystemHealth() {
            log('üíö Testing system health...', null, 'pending');
            try {
                const result = await apiCall('/health');
                log('‚úÖ System health check passed', result, 'success');
                
                // Test API info
                const apiInfo = await apiCall('/');
                log('‚úÖ API info check passed', apiInfo, 'success');
                
                return { health: result, info: apiInfo };
            } catch (error) {
                log('‚ùå System health test failed', { message: error.message }, 'error');
                throw error;
            }
        }

        // Implement authenticated API test helper function
        async function ensureAuthenticated() {
            if (!config.authToken) {
                log('üîë No auth token, running auth flow first...', null, 'info');
                await testAuthEndpoints();
            }
            
            if (!config.authToken) {
                throw new Error('Unable to authenticate for API testing');
            }
            
            return config.authToken;
        }

        // Placeholder functions for other test categories with proper auth handling
        async function testComplianceAPIs() { 
            log('‚úÖ Testing compliance APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Compliance APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Compliance APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testEvidenceAPIs() { 
            log('üìÅ Testing evidence APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Evidence APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Evidence APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testSecurityAPIs() { 
            log('üîí Testing security APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Security APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Security APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testUKComplianceAPIs() { 
            log('üá¨üáß Testing UK compliance APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è UK compliance APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå UK compliance APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testMonitoringAPIs() { 
            log('üìä Testing monitoring APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Monitoring APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Monitoring APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testPerformanceAPIs() { 
            log('‚ö° Testing performance APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Performance APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Performance APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testReportingAPIs() { 
            log('üìã Testing reporting APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Reporting APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Reporting APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testIntegrationAPIs() { 
            log('üîå Testing integration APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Integration APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Integration APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testAdminAPIs() { 
            log('üîß Testing admin APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Admin APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Admin APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testUserManagement() { 
            log('üë• Testing user management...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è User management APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå User management APIs authentication failed', { message: error.message }, 'error');
            }
        }
        
        async function testDatabaseAPIs() { 
            log('üóÑÔ∏è Testing database APIs...', null, 'pending'); 
            try {
                await ensureAuthenticated();
                log('‚ÑπÔ∏è Database APIs endpoints not yet implemented in test suite', null, 'info');
            } catch (error) {
                log('‚ùå Database APIs authentication failed', { message: error.message }, 'error');
            }
        }

        // Comprehensive Test Suites
        async function runCriticalTests() {
            log('‚ö° Starting critical tests...', null, 'info');
            clearLog();
            
            const tests = [
                testConnection,
                testSystemHealth,
                testFreemiumFlow,
                testFrameworkAPIs
            ];
            
            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 500)); // Brief delay
                } catch (error) {
                    log(`‚ùå Critical test failed: ${test.name}`, { message: error.message }, 'error');
                }
            }
            
            log('‚ö° Critical tests completed', { 
                total: stats.total, 
                passed: stats.passed, 
                failed: stats.failed 
            }, 'info');
        }

        async function runAllTests() {
            log('üöÄ Starting comprehensive API test suite...', null, 'info');
            clearLog();
            
            // Run authentication first, then all other tests
            const testSuites = [
                testConnection,
                testSystemHealth,
                testAuthEndpoints,  // Moved auth to beginning
                testFreemiumFlow,
                testFrameworkAPIs,
                testAssessmentAPIs,
                testBusinessProfiles,
                testPolicyAPIs,
                testAIAssessments,
                testAIPolicyGeneration,
                testChatAPIs,
                testAICostMonitoring
            ];
            
            for (const test of testSuites) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Brief delay between tests
                } catch (error) {
                    log(`‚ùå Test suite failed: ${test.name}`, { message: error.message }, 'error');
                }
            }
            
            log('üéâ All tests completed!', { 
                total: stats.total, 
                passed: stats.passed, 
                failed: stats.failed,
                successRate: `${Math.round((stats.passed / stats.total) * 100)}%`
            }, 'success');
        }

        async function runLoadTest() {
            log('üî• Starting load test...', null, 'pending');
            log('‚ö†Ô∏è Load test not yet implemented', null, 'pending');
        }

        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                config: config,
                stats: stats,
                tests: Array.from(document.querySelectorAll('.trace-step')).map(step => ({
                    timestamp: step.querySelector('strong').textContent,
                    content: step.textContent,
                    status: step.className.split(' ')[1]
                }))
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ruleiq-api-test-results-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üìä Test results exported', { filename: a.download }, 'success');
        }

        // Initialize
        window.addEventListener('load', () => {
            updateConfig();
            log('üöÄ ruleIQ API Debug Suite initialized', { version: '2.0.0' }, 'info');
        });
    </script>
</body>
</html>