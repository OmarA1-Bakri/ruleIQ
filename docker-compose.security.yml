version: '3.8'

# Security-hardened Docker Compose configuration
# Use with: docker-compose -f docker-compose.prod.yml -f docker-compose.security.yml up

services:
  app:
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,uid=1001,gid=1001,mode=1700
      - /app/logs:size=50M,uid=1001,gid=1001,mode=0755
    sysctls:
      - net.core.somaxconn=1024
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535

  celery_worker:
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,uid=1001,gid=1001,mode=1700
      - /app/logs:size=50M,uid=1001,gid=1001,mode=0755
    ulimits:
      nproc: 32768
      nofile:
        soft: 32768
        hard: 32768

  celery_beat:
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,uid=1001,gid=1001,mode=1700
      - /app/logs:size=50M,uid=1001,gid=1001,mode=0755
    ulimits:
      nproc: 1024
      nofile:
        soft: 1024
        hard: 1024

  db:
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=100M,mode=1700
      - /var/run/postgresql:size=100M,mode=0755
    ulimits:
      nproc: 2048
      nofile:
        soft: 2048
        hard: 2048

  redis:
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=100M,mode=1700
    ulimits:
      nproc: 1024
      nofile:
        soft: 1024
        hard: 1024

  nginx:
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1700
      - /var/cache/nginx:size=100M,mode=0755
      - /var/log/nginx:size=100M,mode=0755
      - /var/run:size=100M,mode=0755
    ulimits:
      nproc: 1024
      nofile:
        soft: 8192
        hard: 8192